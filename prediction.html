<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GlacioNet | Glacier Melt Predictions</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-blue: #2563eb;
        --secondary-orange: #f97316;
        --success-green: #10b981;
        --dark-bg: #1f2937;
      }
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: "Segoe UI", sans-serif;
      }
      .main-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin: 2rem auto;
        padding: 2rem;
        animation: fadeInUp 1s ease-out forwards;
      }
      .header-section h1 {
        color: var(--dark-bg);
        font-weight: 700;
      }
      .chart-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      .metric-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
      }
      .r-squared {
        color: var(--success-green);
      }
      .rmse {
        color: var(--secondary-orange);
      }
      .mae {
        color: var(--primary-blue);
      }
      .next-button {
        background: linear-gradient(
          135deg,
          var(--primary-blue),
          var(--secondary-orange)
        );
        border: none;
        color: white;
        padding: 1rem 3rem;
        font-size: 1.2rem;
        border-radius: 50px;
        transition: all 0.3s ease;
        opacity: 0.5;
        pointer-events: none;
      }
      .next-button.unlocked {
        opacity: 1;
        pointer-events: all;
        animation: pulse 2s infinite;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes pulse {
        50% {
          box-shadow: 0 0 0 20px rgba(37, 99, 235, 0);
        }
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="main-container">
        <div class="header-section text-center mb-5">
          <h1>
            <i class="fas fa-mountain"></i> Predicted Glacier Melt & Mass Loss
          </h1>
          <p class="lead text-muted">
            AI models have forecasted glacier melt runoff and mass loss. The
            results below compare predicted values against actual observations.
          </p>
        </div>

        <div class="graph-section mb-5">
          <div class="chart-container mb-4">
            <h3 class="text-center mb-3">
              <i class="fas fa-chart-line"></i> Actual vs Predicted Runoff
            </h3>
            <canvas id="runoffChart" height="200"></canvas>
          </div>
          <div class="chart-container">
            <h3 class="text-center mb-3">
              <i class="fas fa-chart-bar"></i> Annual Glacier Mass Loss
              (Gigatons)
            </h3>
            <canvas id="massLossChart" height="200"></canvas>
          </div>
        </div>

        <div class="metrics-section mb-5">
          <h2 class="text-center mb-4">
            <i class="fas fa-analytics"></i> Model Performance Metrics
          </h2>
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="metric-card">
                <div class="metric-value r-squared" id="r2Value">0.00</div>
                <div>RÂ² Score</div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="metric-card">
                <div class="metric-value rmse" id="rmseValue">0.0</div>
                <div>RMSE</div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="metric-card">
                <div class="metric-value mae" id="maeValue">0.0</div>
                <div>MAE</div>
              </div>
            </div>
          </div>
        </div>

        <div class="navigation-section text-center">
          <button class="next-button" id="nextButton">
            <span class="loading-spinner" id="loadingSpinner"></span>
            <span id="buttonText">Processing Predictions...</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- DATA SIMULATION & FETCHING ---
      function getPredictionData() {
        const uploadedDataStr = sessionStorage.getItem("userUploadedData");
        if (uploadedDataStr) {
          console.log("Using user-uploaded data for prediction graph.");
          const data = JSON.parse(uploadedDataStr);
          return {
            labels: data.labels,
            actual: data.actualData,
            predicted: data.predictedData,
          };
        }

        console.log("No user data found. Using fallback sample data.");
        // Fallback to generate random data if nothing is in session storage
        const labels = [];
        const actual = [];
        for (let i = 0; i < 18; i++) {
          const date = new Date(2020, i, 1);
          labels.push(
            date.toLocaleString("default", { month: "short", year: "numeric" })
          );
          const seasonalFactor = Math.sin((i * Math.PI) / 6) * 15;
          actual.push(55 + seasonalFactor + (Math.random() * 10 - 5));
        }
        const predicted = actual.map((val) => val + (Math.random() * 6 - 3));
        return { labels, actual, predicted };
      }

      const runoffData = getPredictionData();
      const massLossData = {
        years: ["2018", "2019", "2020", "2021", "2022", "2023"],
        massLoss: [234, 267, 298, 312, 345, 378].map(
          (v) => v + Math.floor(Math.random() * 20 - 10)
        ),
      };
      const metrics = { r2: 0.89, rmse: 9.3, mae: 5.4 };

      // --- CHART RENDERING ---
      document.addEventListener("DOMContentLoaded", function () {
        const runoffCtx = document
          .getElementById("runoffChart")
          .getContext("2d");
        const massLossCtx = document
          .getElementById("massLossChart")
          .getContext("2d");

        const runoffChart = new Chart(runoffCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Actual Runoff",
                data: [],
                borderColor: "#2563eb",
                tension: 0.4,
                fill: true,
              },
              {
                label: "Predicted Runoff",
                data: [],
                borderColor: "#f97316",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: { responsive: true, animation: { duration: 500 } },
        });

        new Chart(massLossCtx, {
          type: "bar",
          data: {
            labels: massLossData.years,
            datasets: [
              {
                label: "Mass Loss (Gt)",
                data: massLossData.massLoss,
                backgroundColor: massLossData.massLoss.map((v) =>
                  v > 300 ? "#ef4444" : "#10b981"
                ),
              },
            ],
          },
          options: { responsive: true },
        });

        // --- DYNAMIC RENDERING SIMULATION ---
        let dataIndex = 0;
        const interval = setInterval(() => {
          if (dataIndex < runoffData.labels.length) {
            runoffChart.data.labels.push(runoffData.labels[dataIndex]);
            runoffChart.data.datasets[0].data.push(
              runoffData.actual[dataIndex]
            );
            runoffChart.data.datasets[1].data.push(
              runoffData.predicted[dataIndex]
            );
            runoffChart.update();
            dataIndex++;
          } else {
            clearInterval(interval);
            animateMetrics();
          }
        }, 150);
      });

      // --- METRICS AND NAVIGATION ---
      function animateMetrics() {
        animateCounter("r2Value", 0, metrics.r2, 1500, 2);
        animateCounter("rmseValue", 0, metrics.rmse, 1500, 1);
        animateCounter("maeValue", 0, metrics.mae, 1500, 1);
        setTimeout(unlockNavigation, 2000);
      }

      function animateCounter(id, start, end, duration, decimals) {
        const el = document.getElementById(id);
        const range = end - start;
        let current = start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(
          Math.floor(duration / (range / (1 / 10 ** decimals)))
        );
        const timer = setInterval(
          () => {
            current += increment / 10 ** decimals;
            el.textContent = current.toFixed(decimals);
            if (Math.abs(current - end) < 1 / 10 ** decimals) {
              clearInterval(timer);
              el.textContent = end.toFixed(decimals);
            }
          },
          stepTime > 0 ? stepTime : 1
        );
      }

      function unlockNavigation() {
        const button = document.getElementById("nextButton");
        document.getElementById("loadingSpinner").style.display = "none";
        document.getElementById("buttonText").textContent =
          "Next â Freshwater Stress Index";
        button.classList.add("unlocked");
        button.addEventListener("click", () => {
          window.location.href = "freshwaterstress.html";
        });
      }
    </script>
  </body>
</html>
